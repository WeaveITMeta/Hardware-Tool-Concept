// Title Bar Component
// Contains: System menus, mode switcher, view tabs, search, undo/redo, save

import { Theme } from "theme.slint";

// Menu item data structure
export struct MenuItem {
    label: string,
    shortcut: string,
    enabled: bool,
    separator-after: bool,
}

// Menu bar button component
export component MenuButton inherits Rectangle {
    in property <string> label;
    in-out property <bool> menu-open: false;
    callback clicked;
    
    width: label-text.preferred-width + 16px;
    height: 24px;
    background: menu-open ? Theme.bg-tertiary : 
                ta.has-hover ? Theme.bg-tertiary.with-alpha(0.5) : transparent;
    border-radius: Theme.radius-sm;
    
    label-text := Text {
        text: label;
        color: Theme.text-primary;
        font-size: 12px;
        horizontal-alignment: center;
        vertical-alignment: center;
    }
    
    ta := TouchArea {
        clicked => {
            root.clicked();
        }
    }
}

// Menu dropdown component (rendered at window level)
export component MenuDropdown inherits Rectangle {
    in property <string> title;
    in property <[MenuItem]> items;
    callback item-clicked(int);
    
    // Dynamic width based on content
    width: max(160px, min(280px, menu-content.preferred-width + 8px));
    height: menu-content.preferred-height + 8px;
    background: Theme.bg-elevated;
    border-radius: Theme.radius-md;
    border-width: 1px;
    border-color: Theme.border-default;
    drop-shadow-blur: 12px;
    drop-shadow-color: #00000060;
    drop-shadow-offset-y: 4px;
    
    menu-content := VerticalLayout {
        padding: 4px;
        spacing: 0px;
        
        for item[idx] in items: Rectangle {
            height: item.label == "" ? 9px : 28px;
            
            if item.label == "": Rectangle {
                height: 1px;
                y: 4px;
                background: Theme.border-subtle;
            }
            
            if item.label != "": Rectangle {
                background: item.enabled && item-ta.has-hover ? Theme.bg-tertiary : transparent;
                border-radius: Theme.radius-sm;
                
                HorizontalLayout {
                    padding-left: Theme.spacing-md;
                    padding-right: Theme.spacing-md;
                    
                    Text {
                        text: item.label;
                        color: item.enabled ? Theme.text-primary : Theme.text-disabled;
                        font-size: 12px;
                        vertical-alignment: center;
                    }
                    
                    Rectangle { }
                    
                    Text {
                        text: item.shortcut;
                        color: Theme.text-tertiary;
                        font-size: 11px;
                        vertical-alignment: center;
                        horizontal-alignment: right;
                        min-width: 60px;
                    }
                }
                
                item-ta := TouchArea {
                    enabled: item.enabled;
                    clicked => {
                        root.item-clicked(idx);
                    }
                }
            }
        }
    }
}

// Domain selector button (dropdown is rendered at window level for proper z-index)
export component DomainSelector inherits Rectangle {
    in property <int> current-domain: 0;
    in property <[string]> domain-names: ["PCB", "IC", "Quantum", "MEMS", "RF", "Packaging"];
    in property <[string]> domain-icons: ["üî≤", "üî∑", "‚öõÔ∏è", "üì°", "üì∂", "üì¶"];
    in property <[color]> domain-colors: [#006847, #3498DB, #9B59B6, #1ABC9C, #E67E22, #7F8C8D];
    in-out property <bool> dropdown-open: false;
    callback domain-changed(int);
    
    width: 120px;
    height: 32px;
    background: Theme.bg-tertiary;
    border-radius: Theme.radius-md;
    border-width: dropdown-open ? 1px : 0px;
    border-color: domain-colors[current-domain];
    
    HorizontalLayout {
        padding: Theme.spacing-sm;
        spacing: Theme.spacing-xs;
        
        Text {
            text: domain-icons[current-domain];
            font-size: 14px;
            vertical-alignment: center;
        }
        
        Text {
            text: domain-names[current-domain];
            color: Theme.text-primary;
            font-size: 13px;
            font-weight: 500;
            vertical-alignment: center;
        }
        
        Text {
            text: dropdown-open ? "‚ñ≤" : "‚ñº";
            color: Theme.text-secondary;
            font-size: 10px;
            vertical-alignment: center;
        }
    }
    
    TouchArea {
        clicked => {
            dropdown-open = !dropdown-open;
        }
    }
}

// Separate dropdown overlay component to be rendered at window level
export component DomainDropdown inherits Rectangle {
    in property <int> current-domain: 0;
    in property <[string]> domain-names: ["PCB", "IC", "Quantum", "MEMS", "RF", "Packaging"];
    in property <[string]> domain-icons: ["üî≤", "üî∑", "‚öõÔ∏è", "üì°", "üì∂", "üì¶"];
    in property <[color]> domain-colors: [#006847, #3498DB, #9B59B6, #1ABC9C, #E67E22, #7F8C8D];
    callback domain-selected(int);
    callback close-requested;
    
    width: 160px;
    height: 6 * 36px + 8px;
    background: Theme.bg-elevated;
    border-radius: Theme.radius-md;
    border-width: 1px;
    border-color: Theme.border-default;
    drop-shadow-blur: 12px;
    drop-shadow-color: #00000060;
    drop-shadow-offset-y: 4px;
    
    VerticalLayout {
        padding: 4px;
        spacing: 0px;
        
        for domain[idx] in domain-names: Rectangle {
            height: 36px;
            background: idx == current-domain ? domain-colors[idx].with-alpha(0.2) : 
                        item-ta.has-hover ? Theme.bg-tertiary : transparent;
            border-radius: Theme.radius-sm;
            
            HorizontalLayout {
                padding-left: Theme.spacing-md;
                padding-right: Theme.spacing-md;
                spacing: Theme.spacing-sm;
                
                Text {
                    text: domain-icons[idx];
                    font-size: 16px;
                    vertical-alignment: center;
                }
                
                Text {
                    text: domain;
                    color: idx == current-domain ? domain-colors[idx] : Theme.text-primary;
                    font-size: 13px;
                    font-weight: idx == current-domain ? 600 : 400;
                    vertical-alignment: center;
                }
                
                Rectangle { }
                
                if idx == current-domain: Text {
                    text: "‚úì";
                    color: domain-colors[idx];
                    font-size: 14px;
                    vertical-alignment: center;
                }
            }
            
            item-ta := TouchArea {
                clicked => {
                    root.domain-selected(idx);
                }
            }
        }
    }
}

export component ViewTab inherits Rectangle {
    in property <string> label;
    in property <string> icon;
    in property <string> tooltip: "";
    in property <string> shortcut: "";
    in property <bool> active: false;
    callback clicked;
    
    width: self.preferred-width;
    height: 32px;
    background: active ? Theme.bg-tertiary : ta.has-hover ? Theme.bg-tertiary.with-alpha(0.5) : transparent;
    border-radius: Theme.radius-md;
    
    HorizontalLayout {
        padding-left: Theme.spacing-md;
        padding-right: Theme.spacing-md;
        spacing: Theme.spacing-xs;
        
        Text {
            text: icon;
            font-size: 14px;
            vertical-alignment: center;
        }
        
        Text {
            text: label;
            color: active ? Theme.text-primary : Theme.text-secondary;
            font-size: 13px;
            font-weight: active ? 500 : 400;
            vertical-alignment: center;
        }
    }
    
    ta := TouchArea {
        clicked => { root.clicked(); }
        
        moved => {
            if self.has-hover && (root.tooltip != "" || root.shortcut != "") {
                Theme.tooltip-x = self.mouse-x + root.absolute-position.x + 16px;
                Theme.tooltip-y = self.mouse-y + root.absolute-position.y + 16px;
            }
        }
    }
    
    // Timer for delayed tooltip
    Timer {
        interval: 500ms;
        running: ta.has-hover && (root.tooltip != "" || root.shortcut != "");
        triggered => {
            if ta.has-hover {
                Theme.tooltip-text = root.tooltip != "" ? 
                    (root.shortcut != "" ? root.tooltip + " (" + root.shortcut + ")" : root.tooltip) :
                    root.label + " (" + root.shortcut + ")";
                Theme.tooltip-visible = true;
            }
        }
    }
    
    // Hide tooltip when not hovering
    if !ta.has-hover: Rectangle {
        init => {
            Theme.tooltip-visible = false;
        }
    }
}

export component IconButton inherits Rectangle {
    in property <string> icon;
    in property <string> tooltip: "";
    in property <bool> enabled: true;
    callback clicked;
    
    width: 32px;
    height: 32px;
    background: ta.has-hover ? Theme.bg-tertiary : transparent;
    border-radius: Theme.radius-md;
    opacity: enabled ? 1.0 : 0.5;
    
    Text {
        text: icon;
        font-size: 16px;
        horizontal-alignment: center;
        vertical-alignment: center;
    }
    
    ta := TouchArea {
        enabled: root.enabled;
        clicked => { root.clicked(); }
        
        moved => {
            if self.has-hover && root.tooltip != "" {
                Theme.tooltip-x = self.mouse-x + root.absolute-position.x + 16px;
                Theme.tooltip-y = self.mouse-y + root.absolute-position.y + 16px;
            }
        }
    }
    
    // Timer for delayed tooltip
    Timer {
        interval: 500ms;
        running: ta.has-hover && root.tooltip != "";
        triggered => {
            if ta.has-hover {
                Theme.tooltip-text = root.tooltip;
                Theme.tooltip-visible = true;
            }
        }
    }
    
    // Hide tooltip when not hovering
    if !ta.has-hover: Rectangle {
        init => {
            Theme.tooltip-visible = false;
        }
    }
}

export component TitleBar inherits Rectangle {
    in property <string> project-name: "Untitled";
    in property <bool> unsaved: false;
    in property <int> current-domain: 0;
    in property <int> current-view: 0;
    in-out property <bool> domain-dropdown-open: false;
    
    // Menu state (which menu is open: 0=none, 1=File, 2=Edit, 3=Selection, 4=View, 5=Help)
    in-out property <int> active-menu: 0;
    
    callback domain-changed(int);
    callback view-changed(int);
    callback search-clicked;
    callback undo-clicked;
    callback redo-clicked;
    callback save-clicked;
    callback menu-clicked;
    
    // Menu action callbacks
    callback file-action(int);
    callback edit-action(int);
    callback selection-action(int);
    callback view-action(int);
    callback help-action(int);
    
    height: 72px;  // Two rows: 24px menu bar + 40px toolbar
    background: Theme.bg-secondary;
    border-width: 0px;
    border-color: Theme.border-subtle;
    
    VerticalLayout {
        spacing: 0px;
        
        // Row 1: System menu bar
        Rectangle {
            height: 28px;
            background: Theme.bg-primary;
            
            HorizontalLayout {
                padding-left: Theme.spacing-sm;
                padding-right: Theme.spacing-sm;
                spacing: 0px;
                
                // System menu bar
                HorizontalLayout {
                    spacing: 0px;
                    
                    MenuButton {
                        label: "File";
                        menu-open: root.active-menu == 1;
                        clicked => { root.active-menu = root.active-menu == 1 ? 0 : 1; }
                    }
                    
                    MenuButton {
                        label: "Edit";
                        menu-open: root.active-menu == 2;
                        clicked => { root.active-menu = root.active-menu == 2 ? 0 : 2; }
                    }
                    
                    MenuButton {
                        label: "Selection";
                        menu-open: root.active-menu == 3;
                        clicked => { root.active-menu = root.active-menu == 3 ? 0 : 3; }
                    }
                    
                    MenuButton {
                        label: "View";
                        menu-open: root.active-menu == 4;
                        clicked => { root.active-menu = root.active-menu == 4 ? 0 : 4; }
                    }
                    
                    MenuButton {
                        label: "Help";
                        menu-open: root.active-menu == 5;
                        clicked => { root.active-menu = root.active-menu == 5 ? 0 : 5; }
                    }
                }
                
                // Spacer
                Rectangle { }
                
                // Project name (right side of menu bar)
                Text {
                    text: project-name + (unsaved ? " ‚Ä¢" : "");
                    color: Theme.text-tertiary;
                    font-size: 12px;
                    vertical-alignment: center;
                }
            }
        }
        
        // Row 2: Toolbar
        Rectangle {
            height: 44px;
            background: Theme.bg-secondary;
            
            HorizontalLayout {
                padding: Theme.spacing-sm;
                spacing: Theme.spacing-sm;
                
                // Logo
                Text {
                    text: "‚öô";
                    font-size: 20px;
                    color: Theme.primary;
                    vertical-alignment: center;
                }
                
                // Domain selector button
                domain-selector := DomainSelector {
                    current-domain: root.current-domain;
                    dropdown-open <=> root.domain-dropdown-open;
                    domain-changed(d) => { root.domain-changed(d); }
                }
                
                // Separator
                Rectangle {
                    width: 1px;
                    background: Theme.border-subtle;
                }
                
                // View tabs
                HorizontalLayout {
                    spacing: Theme.spacing-xs;
                    
                    ViewTab {
                        icon: "üìê";
                        label: "Schematic";
                        tooltip: "Schematic Editor";
                        shortcut: "F1";
                        active: current-view == 0;
                        clicked => { root.view-changed(0); }
                    }
                    
                    ViewTab {
                        icon: "üî≤";
                        label: "Layout";
                        tooltip: "PCB Layout Editor";
                        shortcut: "F2";
                        active: current-view == 1;
                        clicked => { root.view-changed(1); }
                    }
                    
                    ViewTab {
                        icon: "üé≤";
                        label: "3D";
                        tooltip: "3D Viewer";
                        shortcut: "F3";
                        active: current-view == 2;
                        clicked => { root.view-changed(2); }
                    }
                    
                    ViewTab {
                        icon: "üíª";
                        label: "Code";
                        tooltip: "Programmatic Design";
                        shortcut: "F4";
                        active: current-view == 3;
                        clicked => { root.view-changed(3); }
                    }
                }
                
                // Spacer
                Rectangle { }
                
                // Search button
                Rectangle {
                    width: 200px;
                    height: 32px;
                    background: Theme.bg-tertiary;
                    border-radius: Theme.radius-md;
                    
                    HorizontalLayout {
                        padding-left: Theme.spacing-md;
                        padding-right: Theme.spacing-md;
                        
                        Text {
                            text: "üîç Search...";
                            color: Theme.text-tertiary;
                            font-size: 13px;
                            vertical-alignment: center;
                        }
                        
                        Rectangle { }
                        
                        Text {
                            text: "Ctrl+K";
                            color: Theme.text-disabled;
                            font-size: 11px;
                            vertical-alignment: center;
                        }
                    }
                    
                    TouchArea {
                        clicked => { root.search-clicked(); }
                    }
                }
                
                // Separator
                Rectangle {
                    width: 1px;
                    background: Theme.border-subtle;
                }
                
                // Action buttons
                HorizontalLayout {
                    spacing: Theme.spacing-xs;
                    
                    IconButton {
                        icon: "‚Ü©Ô∏è";
                        tooltip: "Undo (Ctrl+Z)";
                        clicked => { root.undo-clicked(); }
                    }
                    
                    IconButton {
                        icon: "‚Ü™Ô∏è";
                        tooltip: "Redo (Ctrl+Y)";
                        clicked => { root.redo-clicked(); }
                    }
                    
                    IconButton {
                        icon: "üíæ";
                        tooltip: "Save (Ctrl+S)";
                        clicked => { root.save-clicked(); }
                    }
                }
            }
        }
    }
    
    // Bottom border accent (domain color)
    Rectangle {
        y: parent.height - 2px;
        height: 2px;
        background: current-domain == 0 ? Theme.domain-pcb :
                    current-domain == 1 ? Theme.domain-ic :
                    current-domain == 2 ? Theme.domain-quantum :
                    current-domain == 3 ? Theme.domain-mems :
                    current-domain == 4 ? Theme.domain-rf :
                    Theme.domain-packaging;
    }
}
