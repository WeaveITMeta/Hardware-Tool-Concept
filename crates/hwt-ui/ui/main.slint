// Hardware Tool Main Window
// "One Hardware Tool That Does It All"

import { Theme } from "theme.slint";
import { TitleBar, DomainDropdown, MenuDropdown, MenuItem } from "title_bar.slint";
import { LeftSidebar } from "left_sidebar.slint";
import { RightSidebar } from "right_sidebar.slint";
import { BottomBar } from "bottom_bar.slint";
import { Canvas, Floating3DPanel } from "canvas.slint";
import { TooltipOverlay } from "tooltip.slint";
import { SchematicEditor, EditorTool, WireMode, SymbolData, PlacedSymbolView, WireSegmentView, JunctionView, NetLabelView } from "schematic_editor.slint";

export component MainWindow inherits Window {
    title: "Hardware Tool";
    icon: @image-url("../assets/icon.svg");
    min-width: 1024px;
    min-height: 768px;
    preferred-width: 1600px;
    preferred-height: 900px;
    background: Theme.bg-primary;
    
    // Application state
    in-out property <string> project-name: "Untitled";
    in-out property <bool> unsaved: false;
    in-out property <int> current-domain: 0;
    in-out property <int> current-view: 0;
    in-out property <bool> left-sidebar-collapsed: false;
    in-out property <bool> right-sidebar-collapsed: false;
    in-out property <bool> show-3d-panel: true;
    in-out property <bool> panel-3d-maximized: false;
    in-out property <bool> domain-dropdown-open: false;
    in-out property <int> active-menu: 0;
    
    // Menu item definitions
    property <[MenuItem]> file-menu-items: [
        { label: "New Project", shortcut: "Ctrl+N", enabled: true, separator-after: false },
        { label: "Open Project", shortcut: "Ctrl+O", enabled: true, separator-after: false },
        { label: "Open Recent", shortcut: "", enabled: true, separator-after: true },
        { label: "", shortcut: "", enabled: false, separator-after: false },
        { label: "Save", shortcut: "Ctrl+S", enabled: true, separator-after: false },
        { label: "Save As...", shortcut: "Ctrl+Shift+S", enabled: true, separator-after: false },
        { label: "Export", shortcut: "Ctrl+E", enabled: true, separator-after: true },
        { label: "", shortcut: "", enabled: false, separator-after: false },
        { label: "Close", shortcut: "Ctrl+W", enabled: true, separator-after: false },
        { label: "Quit", shortcut: "Ctrl+Q", enabled: true, separator-after: false },
    ];
    
    property <[MenuItem]> edit-menu-items: [
        { label: "Undo", shortcut: "Ctrl+Z", enabled: true, separator-after: false },
        { label: "Redo", shortcut: "Ctrl+Y", enabled: true, separator-after: true },
        { label: "", shortcut: "", enabled: false, separator-after: false },
        { label: "Cut", shortcut: "Ctrl+X", enabled: true, separator-after: false },
        { label: "Copy", shortcut: "Ctrl+C", enabled: true, separator-after: false },
        { label: "Paste", shortcut: "Ctrl+V", enabled: true, separator-after: false },
        { label: "Duplicate", shortcut: "Ctrl+D", enabled: true, separator-after: true },
        { label: "", shortcut: "", enabled: false, separator-after: false },
        { label: "Delete", shortcut: "Del", enabled: true, separator-after: false },
        { label: "Select All", shortcut: "Ctrl+A", enabled: true, separator-after: false },
    ];
    
    property <[MenuItem]> selection-menu-items: [
        { label: "Select All", shortcut: "Ctrl+A", enabled: true, separator-after: false },
        { label: "Deselect All", shortcut: "Esc", enabled: true, separator-after: false },
        { label: "Invert Selection", shortcut: "Ctrl+I", enabled: true, separator-after: true },
        { label: "", shortcut: "", enabled: false, separator-after: false },
        { label: "Select by Net", shortcut: "", enabled: true, separator-after: false },
        { label: "Select by Component", shortcut: "", enabled: true, separator-after: false },
        { label: "Select Connected", shortcut: "", enabled: true, separator-after: false },
    ];
    
    property <[MenuItem]> view-menu-items: [
        { label: "Zoom In", shortcut: "Ctrl++", enabled: true, separator-after: false },
        { label: "Zoom Out", shortcut: "Ctrl+-", enabled: true, separator-after: false },
        { label: "Fit to Screen", shortcut: "Ctrl+0", enabled: true, separator-after: false },
        { label: "Zoom to Selection", shortcut: "Ctrl+1", enabled: true, separator-after: true },
        { label: "", shortcut: "", enabled: false, separator-after: false },
        { label: "Toggle Grid", shortcut: "G", enabled: true, separator-after: false },
        { label: "Toggle Ratsnest", shortcut: "R", enabled: true, separator-after: true },
        { label: "", shortcut: "", enabled: false, separator-after: false },
        { label: "3D Preview Panel", shortcut: "F8", enabled: true, separator-after: false },
        { label: "Left Sidebar", shortcut: "Ctrl+[", enabled: true, separator-after: false },
        { label: "Right Sidebar", shortcut: "Ctrl+]", enabled: true, separator-after: false },
    ];
    
    property <[MenuItem]> help-menu-items: [
        { label: "Documentation", shortcut: "F1", enabled: true, separator-after: false },
        { label: "Keyboard Shortcuts", shortcut: "Ctrl+?", enabled: true, separator-after: true },
        { label: "", shortcut: "", enabled: false, separator-after: false },
        { label: "Check for Updates", shortcut: "", enabled: true, separator-after: false },
        { label: "About Hardware Tool", shortcut: "", enabled: true, separator-after: false },
    ];
    
    // Canvas state
    in-out property <float> zoom: 1.0;
    in-out property <float> cursor-x: 0.0;
    in-out property <float> cursor-y: 0.0;
    in-out property <int> selection-count: 0;
    
    // Schematic editor state
    in-out property <EditorTool> schematic-tool: EditorTool.select;
    in-out property <WireMode> wire-mode: WireMode.horizontal-first;
    in-out property <SymbolData> placing-symbol: { library: "", name: "", reference-prefix: "", value: "" };
    in-out property <bool> is-placing-symbol: false;
    in-out property <[PlacedSymbolView]> placed-symbols: [];
    in-out property <[WireSegmentView]> placed-wires: [];
    in-out property <[JunctionView]> placed-junctions: [];
    in-out property <[NetLabelView]> placed-labels: [];
    
    // Performance
    in-out property <int> fps: 60;
    in-out property <int> memory-mb: 245;
    
    // Callbacks
    callback domain-changed(int);
    callback view-changed(int);
    callback save-requested;
    callback undo-requested;
    callback redo-requested;
    callback search-requested;
    
    // Schematic editor callbacks
    callback schematic-tool-changed(EditorTool);
    callback symbol-placed(float, float, int);
    callback wire-started(float, float);
    callback wire-segment-added(float, float, float, float);
    callback wire-completed;
    callback junction-placed(float, float);
    callback label-placed(float, float);
    callback no-connect-placed(float, float);
    callback element-selected(string);
    callback selection-cleared;
    
    // Title bar - fixed at top
    TitleBar {
        x: 0px;
        y: 0px;
        width: 100%;
        project-name: root.project-name;
        unsaved: root.unsaved;
        current-domain: root.current-domain;
        current-view: root.current-view;
        domain-dropdown-open <=> root.domain-dropdown-open;
        active-menu <=> root.active-menu;
        
        domain-changed(d) => { 
            root.current-domain = d;
            Theme.current-domain = d;
            root.domain-changed(d); 
        }
        view-changed(v) => { 
            root.current-view = v;
            root.view-changed(v); 
        }
        search-clicked => { root.search-requested(); }
        undo-clicked => { root.undo-requested(); }
        redo-clicked => { root.redo-requested(); }
        save-clicked => { root.save-requested(); }
        menu-clicked => { }
    }
    
    // Main content area - positioned below title bar
    HorizontalLayout {
        x: 0px;
        y: Theme.titlebar-height;
        width: 100%;
        height: root.height - Theme.titlebar-height - Theme.bottombar-height;
        spacing: 0px;
        
        // Left sidebar
        LeftSidebar {
            collapsed: root.left-sidebar-collapsed;
        }
        
        // Left separator line
        Rectangle {
            width: 1px;
            background: Theme.border-subtle;
        }
        
        // Canvas area with floating 3D panel
        Rectangle {
            // Schematic editor (when in schematic view)
            if current-view == 0: SchematicEditor {
                zoom: root.zoom;
                current-tool <=> root.schematic-tool;
                wire-mode <=> root.wire-mode;
                placing-symbol: root.placing-symbol;
                is-placing: root.is-placing-symbol;
                symbols: root.placed-symbols;
                wires: root.placed-wires;
                junctions: root.placed-junctions;
                labels: root.placed-labels;
                
                tool-changed(tool) => { root.schematic-tool-changed(tool); }
                mouse-moved(x, y) => {
                    root.cursor-x = x;
                    root.cursor-y = y;
                }
                symbol-placed(x, y, r) => { root.symbol-placed(x, y, r); }
                wire-started(x, y) => { root.wire-started(x, y); }
                wire-segment-added(sx, sy, ex, ey) => { root.wire-segment-added(sx, sy, ex, ey); }
                wire-completed => { root.wire-completed(); }
                junction-placed(x, y) => { root.junction-placed(x, y); }
                label-placed(x, y) => { root.label-placed(x, y); }
                no-connect-placed(x, y) => { root.no-connect-placed(x, y); }
                element-selected(id) => { root.element-selected(id); }
                selection-cleared => { root.selection-cleared(); }
                zoom-changed(z) => { root.zoom = clamp(z, 0.1, 10.0); }
            }
            
            // Layout/3D/Code views use generic canvas
            if current-view != 0: Canvas {
                zoom: root.zoom;
                
                mouse-moved(x, y) => {
                    root.cursor-x = x;
                    root.cursor-y = y;
                }
                
                zoom-changed(z) => {
                    root.zoom = clamp(z, 0.1, 10.0);
                }
            }
            
            // Floating 3D panel (z-index: 1 - above canvas, positioned top-right)
            if show-3d-panel && !panel-3d-maximized: Floating3DPanel {
                width: 320px;
                height: 240px;
                x: parent.width - 320px - 16px;
                y: 16px;
                maximized: false;
                
                maximize-clicked => {
                    root.panel-3d-maximized = true;
                }
                
                close-clicked => {
                    root.show-3d-panel = false;
                }
            }
        }
        
        // Right separator line
        Rectangle {
            width: 1px;
            background: Theme.border-subtle;
        }
        
        // Right sidebar
        RightSidebar {
            collapsed: root.right-sidebar-collapsed;
        }
    }
    
    // Bottom bar - fixed at bottom
    BottomBar {
        x: 0px;
        y: root.height - Theme.bottombar-height;
        width: 100%;
        cursor-x: root.cursor-x;
        cursor-y: root.cursor-y;
        selection-count: root.selection-count;
        fps: root.fps;
        memory-mb: root.memory-mb;
    }
    
    // Maximized 3D panel overlay (z-index: 2 - above everything except dropdowns)
    if panel-3d-maximized: Rectangle {
        x: 0px;
        y: Theme.titlebar-height;
        width: 100%;
        height: root.height - Theme.titlebar-height - Theme.bottombar-height;
        background: transparent;
        
        Floating3DPanel {
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            width: parent.width - 64px;
            height: parent.height - 64px;
            maximized: true;
            
            maximize-clicked => {
                root.panel-3d-maximized = false;
            }
            
            close-clicked => {
                root.panel-3d-maximized = false;
                root.show-3d-panel = false;
            }
        }
    }
    
    // Domain dropdown overlay (z-index: 3 - topmost, above everything)
    if domain-dropdown-open: Rectangle {
        // Click-away backdrop to close dropdown
        x: 0px;
        y: 0px;
        width: 100%;
        height: 100%;
        background: transparent;
        
        TouchArea {
            clicked => {
                root.domain-dropdown-open = false;
            }
        }
        
        // The actual dropdown menu - positioned below the toolbar
        DomainDropdown {
            x: 36px + Theme.spacing-sm;  // Logo width + spacing
            y: Theme.titlebar-height;     // Below both menu bar and toolbar
            current-domain: root.current-domain;
            
            domain-selected(idx) => {
                root.current-domain = idx;
                Theme.current-domain = idx;
                root.domain-changed(idx);
                root.domain-dropdown-open = false;
            }
        }
    }
    
    // System menu dropdowns (z-index: 4 - above domain dropdown)
    if active-menu > 0: Rectangle {
        // Click-away backdrop to close menu
        x: 0px;
        y: 0px;
        width: 100%;
        height: 100%;
        background: transparent;
        
        TouchArea {
            clicked => {
                root.active-menu = 0;
            }
        }
        
        // File menu
        if active-menu == 1: MenuDropdown {
            x: Theme.spacing-sm;
            y: Theme.menubar-height;
            title: "File";
            items: root.file-menu-items;
            
            item-clicked(idx) => {
                root.active-menu = 0;
            }
        }
        
        // Edit menu
        if active-menu == 2: MenuDropdown {
            x: Theme.spacing-sm + 36px;
            y: Theme.menubar-height;
            title: "Edit";
            items: root.edit-menu-items;
            
            item-clicked(idx) => {
                root.active-menu = 0;
            }
        }
        
        // Selection menu
        if active-menu == 3: MenuDropdown {
            x: Theme.spacing-sm + 72px;
            y: Theme.menubar-height;
            title: "Selection";
            items: root.selection-menu-items;
            
            item-clicked(idx) => {
                root.active-menu = 0;
            }
        }
        
        // View menu
        if active-menu == 4: MenuDropdown {
            x: Theme.spacing-sm + 140px;
            y: Theme.menubar-height;
            title: "View";
            items: root.view-menu-items;
            
            item-clicked(idx) => {
                root.active-menu = 0;
            }
        }
        
        // Help menu
        if active-menu == 5: MenuDropdown {
            x: Theme.spacing-sm + 184px;
            y: Theme.menubar-height;
            title: "Help";
            items: root.help-menu-items;
            
            item-clicked(idx) => {
                root.active-menu = 0;
            }
        }
    }
    
    // Tooltip overlay (z-index: 5 - topmost, above everything)
    TooltipOverlay { }
}
